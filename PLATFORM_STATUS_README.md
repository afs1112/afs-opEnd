# PlatformStatus 平台状态协议测试指南

## 概述

本项目已成功添加对 PlatformStatus 协议的支持，包括发送端模拟和接收端解析功能。

## 新增文件

### 1. 测试发送文件
- **文件位置**: `src/testScipt/test-platform-status.js`
- **功能**: 模拟发送平台状态数据的组播测试工具
- **支持的协议**: PlatformStatus.proto 中定义的所有消息类型

### 2. 协议定义文件
- **文件位置**: `src/protobuf/PlatformStatus.proto`
- **功能**: 定义平台状态相关的所有消息结构

## 使用方法

### 启动接收端（主应用）
```bash
cd /Users/xinnix/code/afs/afs-opEnd
npm run dev
```

### 启动测试发送端
```bash
cd /Users/xinnix/code/afs/afs-opEnd
node src/testScipt/test-platform-status.js
```

## 功能特性

### 发送端功能
- ✅ **简化平台数据发送**: 每10秒发送一次基础平台信息
- ✅ **完整平台数据发送**: 每30秒发送一次包含详细设备信息的完整数据
- ✅ **多平台模拟**: 同时模拟4个不同类型的平台（战斗机、轰炸机、预警机、运输机）
- ✅ **详细设备信息**: 包括通信设备、传感器、武器、跟踪目标、航迹点等

### 接收端功能
- ✅ **自动协议加载**: 自动扫描并加载 PlatformStatus.proto
- ✅ **实时数据解析**: 实时解析接收到的平台状态数据
- ✅ **详细信息显示**: 结构化显示平台的各种属性和设备信息
- ✅ **错误处理**: 完善的错误诊断和处理机制

## 支持的数据结构

### 平台基础信息 (PlatformBase)
- 名称、类型、阵营、编队
- 位置信息（经纬度、高度）
- 状态信息（是否损坏等）

### 设备信息
- **推进器 (Mover)**: 引擎类型、航迹点
- **通信设备 (Comm)**: UHF无线电、数据链等
- **传感器 (Sensor)**: 雷达、光电系统等
- **武器 (Weapon)**: 导弹、机炮等
- **跟踪目标 (Track)**: 目标名称、类型等

### 运动参数 (PartParam)
- 转动模式（固定、方位角、俯仰角、双轴）
- 转动范围限制
- 当前姿态角度
- 开关状态

## 数据包格式

```
[包头] [协议ID] [包类型] [数据长度] [Protobuf数据]
 0xAA   0x01     0x29     4字节LE    变长
 0x55
```

- **包类型**: 0x29 (PackType_PlatformStatus)
- **协议ID**: 0x01
- **组播地址**: 239.255.43.21:10086

## 日志示例

### 发送端日志
```
🚀 开始发送PlatformStatus格式的组播测试数据...
🎯 目标地址: 239.255.43.21:10086
📤 发送完整平台状态数据...
✅ 已发送平台状态数据到 239.255.43.21:10086
📦 数据包大小: 3403 字节
📋 包类型: 0x29 (PackType_PlatformStatus)
```

### 接收端日志
```
[Protobuf] ✅ 找到 PlatformStatus.Platforms 类型
[Parser] ✅ 平台状态解码成功
[Multicast][平台状态详情] 🚁 {
  '平台数量': 4,
  '平台信息': [
    {
      '编号': 1,
      '名称': '战斗机-001',
      '类型': 'Fighter',
      '阵营': '友军',
      '编队': '第一编队',
      '通信设备数': 2,
      '传感器数': 2,
      '武器数': 2,
      '跟踪目标数': 2,
      '航迹点数': 3
    }
    // ... 其他3个平台
  ]
}
```

## 技术要点

### 1. 协议支持
- 已在 `protobuf-parser.service.ts` 中添加对 PackType_PlatformStatus (0x29) 的支持
- 正确识别和解析 `PlatformStatus.Platforms` 消息类型

### 2. 数据完整性
- 支持可选字段的处理
- 正确解析嵌套消息结构
- 处理重复字段（如平台列表、设备列表等）

### 3. 错误处理
- 包格式验证
- Protobuf 解析错误诊断
- 详细的调试信息输出

## 扩展说明

该实现完全遵循项目的现有架构：
- 使用相同的组播监听机制
- 遵循统一的包格式标准
- 集成到现有的 Protobuf 解析框架
- 保持与其他协议类型的兼容性

通过这个实现，您可以轻松地测试和验证平台状态数据的发送和接收功能。