# 火炮预计飞行时间功能流程图

## 整体流程

```mermaid
graph TB
    A[装订目标] --> B[发送Arty_Target_Set命令]
    B --> C[平台返回TargetLoad信息]
    C --> D[提取目标距离]
    D --> E[存储targetDistance]
    E --> F[用户点击开火]
    F --> G[发送Arty_Fire命令]
    G --> H{命令发送成功?}
    H -->|是| I[计算飞行时间<br/>t=66+距离-23134/480]
    H -->|否| J[显示错误信息]
    I --> K[更新estimatedFlightTime]
    K --> L[在炮弹状态中显示]
    L --> M[等待3秒]
    M --> N[清空飞行时间显示]
```

## 数据流转

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as 火炮操作界面
    participant S as 系统后端
    participant P as 平台仿真系统

    U->>UI: 1. 点击目标装订
    UI->>S: 2. 发送PlatformCmd(Arty_Target_Set)
    S->>P: 3. 转发装订命令
    P->>S: 4. 返回TargetLoad信息
    S->>UI: 5. 推送TargetLoad数据
    UI->>UI: 6. 提取并存储目标距离

    Note over UI: 装订完成，显示目标参数

    U->>UI: 7. 点击开火
    UI->>S: 8. 发送PlatformCmd(Arty_Fire)
    S->>P: 9. 转发开火命令
    P->>S: 10. 返回发射确认
    S->>UI: 11. 命令执行成功
    UI->>UI: 12. 计算飞行时间
    UI->>UI: 13. 显示预计飞行时间

    Note over UI: 3秒后自动清空显示
```

## 界面状态变化

```mermaid
stateDiagram-v2
    [*] --> 未装订: 初始状态
    未装订 --> 装订中: 点击装订按钮
    装订中 --> 已装订: 收到TargetLoad
    已装订 --> 未装填: 装订成功
    未装填 --> 已装填: 装填弹药
    已装填 --> 开火中: 点击开火
    开火中 --> 显示飞行时间: 开火成功
    显示飞行时间 --> 未装填: 3秒后重置
    已装订 --> 未装订: 断开连接
```

## 关键变量关系

```mermaid
graph LR
    A[TargetLoad.distance] -->|提取| B[targetDistance]
    B -->|输入公式| C[计算逻辑]
    C -->|输出| D[estimatedFlightTime]
    D -->|v-if渲染| E[界面显示]

    F[开火成功] -->|触发| C
    G[3秒定时器] -->|清空| D
```

## 计算公式可视化

```
公式: t = 66 + (距离 - 23134) / 480

参数说明:
├─ t: 预计飞行时间（秒）
├─ 66: 基准飞行时间（秒）
├─ 23134: 基准距离（米）
├─ 480: 距离系数（米/秒）
└─ 距离: 实际目标距离（米）

计算示例:
┌──────────┬────────────────────────────┬──────────┐
│ 距离(m)  │ 计算过程                    │ 结果(秒) │
├──────────┼────────────────────────────┼──────────┤
│ 20000    │ 66 + (20000-23134)/480     │ 59       │
│ 23134    │ 66 + (23134-23134)/480     │ 66       │
│ 25000    │ 66 + (25000-23134)/480     │ 70       │
│ 28000    │ 66 + (28000-23134)/480     │ 76       │
│ 30000    │ 66 + (30000-23134)/480     │ 80       │
└──────────┴────────────────────────────┴──────────┘

特性:
• 距离每增加480m，飞行时间增加1秒
• 距离每减少480m，飞行时间减少1秒
• 基准距离23134m时，飞行时间为66秒
```

## 界面布局结构

```
┌────────────────────────────────────────────────┐
│         火炮操作页面                            │
├────────────────────────────────────────────────┤
│                                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 左侧面板  │  │ 中间面板  │  │ 右侧面板  │    │
│  │          │  │          │  │          │    │
│  │ 任务控制  │  │ 气候环境  │  │ 任务目标  │    │
│  │ 弹药装填  │  │ 平台状态  │  │ 协同报文  │    │
│  │ 开火按钮  │  │ 装订目标  │  │          │    │
│  │          │  │          │  │          │    │
│  │          │  │ 炮弹状态  │  │          │    │
│  │          │  │ ┌──────┐ │  │          │    │
│  │          │  │ │位置   │ │  │          │    │
│  │          │  │ │姿态   │ │  │          │    │
│  │          │  │ │速度   │ │  │          │    │
│  │          │  │ │      │ │  │          │    │
│  │          │  │ │🕒飞行│ │  │          │    │
│  │          │  │ │时间:66秒│ │          │    │
│  │          │  │ └──────┘ │  │          │    │
│  └──────────┘  └──────────┘  └──────────┘    │
│                                                │
└────────────────────────────────────────────────┘

说明:
• 飞行时间显示在炮弹状态卡片底部
• 使用紫色渐变背景突出显示
• 仅在开火后且有距离数据时显示
• 3秒后自动消失
```

## 错误处理流程

```mermaid
graph TD
    A[开火操作] --> B{是否已装订目标?}
    B -->|否| C[禁用开火按钮]
    B -->|是| D{是否有距离数据?}
    D -->|否| E[不显示飞行时间]
    D -->|是| F{命令发送成功?}
    F -->|否| G[显示错误信息]
    F -->|是| H[计算飞行时间]
    H --> I{距离>0?}
    I -->|否| E
    I -->|是| J[显示飞行时间]
```

## 性能优化点

1. **数据更新频率控制**

   - 仅在 TargetLoad 数据变化时更新距离
   - 避免每次状态更新都重新计算

2. **条件渲染优化**

   - 使用`v-if="estimatedFlightTime > 0"`避免无效渲染
   - 减少 DOM 操作开销

3. **定时器管理**

   - 使用 setTimeout 确保状态及时重置
   - 避免内存泄漏

4. **计算效率**
   - 使用 Math.round()一次性完成四舍五入
   - 公式简单，计算开销小

## 测试检查清单

- [x] 公式计算正确性验证
- [x] 边界值测试（距离为 0、负数、极大值）
- [x] 界面显示验证（样式、位置、动画）
- [x] 状态重置验证（3 秒后清空）
- [x] 错误处理验证（无距离数据、发送失败）
- [x] 多次开火验证（重复操作）
- [x] 断线重连验证（状态保持）
- [x] 性能测试（大量数据更新）

---

**创建日期**: 2025-10-13  
**文档版本**: v1.0
