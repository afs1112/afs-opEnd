# 组播监听问题排查指南

## 问题描述
在命令测试页面中更新了platform选项，但在组播监听页面看不到收到的数据报文。

## 可能的原因

### 1. 组播监听服务未启动 🔴
**检查方法：**
- 打开组播监听页面
- 查看状态显示是否为"监听中"（绿色）
- 检查总数据包数是否 > 0

**解决方案：**
- 在组播监听页面点击"开始监听"按钮
- 确认配置正确（地址：239.255.43.21，端口：10086）

### 2. 没有外部数据源发送平台状态 🟡
**检查方法：**
- 查看组播监听页面是否收到任何数据包
- 检查是否有类型为 0x29 (PlatformStatus) 的数据包

**解决方案：**
- 确认有外部系统在发送平台状态数据
- 或者使用模拟数据进行测试

### 3. 数据包解析失败 🟡
**检查方法：**
- 打开开发者工具 (F12)
- 查看控制台是否有解析错误
- 检查主进程日志输出

**解决方案：**
- 确认protobuf定义文件正确加载
- 检查数据包格式是否符合预期

### 4. 网络配置问题 🟢
**检查方法：**
- 检查防火墙设置
- 确认网络接口配置正确
- 测试组播发送和接收

**解决方案：**
- 允许UDP端口10086通过防火墙
- 尝试使用不同的网络接口地址

## 调试步骤

### 步骤1：检查组播监听状态
```bash
# 打开组播监听页面
# 确认状态显示：
# - 状态: 监听中 (绿色)
# - 组播地址: 239.255.43.21
# - 端口: 10086
# - 总数据包: > 0
```

### 步骤2：检查控制台日志
```javascript
// 在命令测试页面的控制台中应该看到：
[CommandTestPage] 设置组播数据监听
[CommandTestPage] 页面已挂载，初始平台数据: ["UAV-001", "ARTY-001"]
[CommandTestPage] 收到组播数据包: {...}
[CommandTestPage] 数据包类型: 0x29 (PlatformStatus)
[CommandTestPage] 平台列表已更新: [...]
```

### 步骤3：检查主进程日志
```bash
# 在终端中应该看到：
[Multicast][调试] 收到数据包: {...}
[Multicast][Protobuf解析成功] ✅ {...}
[Multicast][平台状态详情] 🚁 {...}
```

### 步骤4：测试回环
```bash
# 运行测试脚本
node testScipt/test-multicast-loop.js

# 按照指南进行测试：
# 1. 发送一个传感器命令
# 2. 检查组播监听页面是否收到数据包
# 3. 验证数据包类型为 PlatformCmd (0x2A)
```

## 快速修复方案

### 方案1：重启监听服务
1. 在组播监听页面点击"停止监听"
2. 等待2秒
3. 点击"开始监听"
4. 检查状态是否恢复正常

### 方案2：重启应用程序
1. 关闭应用程序
2. 重新启动应用程序
3. 打开组播监听页面并启动监听
4. 打开命令测试页面检查平台选项

### 方案3：检查网络配置
1. 确认防火墙允许UDP端口10086
2. 尝试更换组播地址或端口
3. 检查网络接口配置

### 方案4：使用模拟数据测试
1. 确认命令测试页面显示模拟平台数据
2. 发送一个测试命令
3. 检查组播监听页面是否收到命令数据包

## 预期的正常流程

### 1. 应用启动
```
主进程启动 → 组播服务初始化 → protobuf解析器加载
```

### 2. 组播监听启动
```
用户点击"开始监听" → 绑定UDP端口 → 加入组播组 → 开始接收数据
```

### 3. 数据包接收
```
收到UDP数据 → 检查包头(AA55) → 解析protobuf → 转发到渲染进程
```

### 4. 命令测试页面处理
```
接收数据包 → 检查类型(0x29) → 解析平台数据 → 更新界面选项
```

## 常见错误和解决方案

### 错误1：端口被占用
```
Error: bind EADDRINUSE :::10086
```
**解决方案：** 更换端口或关闭占用端口的其他应用

### 错误2：组播组加入失败
```
Error: addMembership ENODEV
```
**解决方案：** 检查网络接口配置，尝试使用0.0.0.0

### 错误3：protobuf解析失败
```
Error: Protobuf parsing failed
```
**解决方案：** 检查protobuf定义文件是否正确加载

### 错误4：数据包格式错误
```
包头检查失败: expectedHeader: 'aa55', actualHeader: 'xxxx'
```
**解决方案：** 确认数据源发送的是正确格式的数据包

## 测试用例

### 测试用例1：基本监听功能
1. 启动应用程序
2. 打开组播监听页面
3. 点击"开始监听"
4. 确认状态显示为"监听中"

### 测试用例2：数据包接收
1. 确保监听正常运行
2. 发送一个测试命令
3. 检查监听页面是否显示新数据包
4. 验证数据包解析正确

### 测试用例3：平台数据更新
1. 确保有平台状态数据源
2. 检查命令测试页面平台选项
3. 验证平台数据实时更新
4. 确认选项可以正常选择

## 联系支持

如果按照以上步骤仍无法解决问题，请提供以下信息：
1. 控制台错误日志
2. 主进程日志输出
3. 网络配置信息
4. 操作系统版本
5. 具体的操作步骤和预期结果