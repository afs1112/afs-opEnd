# 组播页面高度设置命令支持

## 功能概述

在组播监听页面（MulticastPage）中增加对高度设置命令（命令 13 - Uav_Set_Altitude）的识别和显示支持，使得当接收到高度设置命令报文时，能够正确解析并以友好的格式展示。

## 修改内容

### 1. 命令名称映射

**文件**: `/Users/xinnix/code/afs/opEnd/src/renderer/views/pages/MulticastPage.vue`

**位置**: 第 1197 行左右的 `commandNames` 对象

**修改**:

```typescript
const commandNames: { [key: number]: string } = {
  0: "无效命令",
  1: "传感器开",
  2: "传感器关",
  3: "传感器转向",
  4: "激光照射",
  5: "停止照射",
  6: "航线规划",
  7: "目标装订",
  8: "火炮发射",
  9: "设置速度",
  10: "锁定目标",
  11: "打击协同",
  12: "发射协同",
  13: "设置高度", // ✅ 新增：高度设置命令
};
```

### 2. 命令详细信息显示

**文件**: `/Users/xinnix/code/afs/opEnd/src/renderer/views/pages/MulticastPage.vue`

**位置**: `getCoordinationCommandDetails` 函数中

**修改**:

```typescript
// 其他参数的快速显示
if (parsedData.sensorParam?.sensorName) {
  return ` (传感器: ${parsedData.sensorParam.sensorName})`;
}

if (parsedData.lockParam?.targetName) {
  return ` (锁定: ${parsedData.lockParam.targetName})`;
}

if (parsedData.fireParam?.targetName) {
  return ` (目标: ${parsedData.fireParam.targetName})`;
}

// ✅ 新增：速度设置参数显示 (9)
if (command === 9 && parsedData.setSpeedParam?.speed !== undefined) {
  return ` (速度: ${parsedData.setSpeedParam.speed}m/s)`;
}

// ✅ 新增：高度设置参数显示 (13)
if (command === 13 && parsedData.setAltitudeParam?.altitude !== undefined) {
  return ` (高度: ${parsedData.setAltitudeParam.altitude}m)`;
}

return "";
```

### 3. 命令摘要导出

**文件**: `/Users/xinnix/code/afs/opEnd/src/renderer/views/pages/MulticastPage.vue`

**位置**: `copyPlatformCmdSummary` 函数中

**修改**:

```typescript
详细参数:
  p.parsedPacket?.parsedData?.strikeCoordinateParam ||
  p.parsedPacket?.parsedData?.fireCoordinateParam ||
  p.parsedPacket?.parsedData?.sensorParam ||
  p.parsedPacket?.parsedData?.lockParam ||
  p.parsedPacket?.parsedData?.fireParam ||
  p.parsedPacket?.parsedData?.setSpeedParam ||      // ✅ 新增
  p.parsedPacket?.parsedData?.setAltitudeParam ||   // ✅ 新增
  null,
```

## 功能特性

### 1. 命令识别

- ✅ 自动识别命令编号为 13 的平台命令
- ✅ 显示为中文名称"设置高度"
- ✅ 支持未知命令的降级显示

### 2. 参数显示

- ✅ 在命令列表中显示高度参数：`设置高度 (高度: XXXXm)`
- ✅ 单位自动添加为"米"
- ✅ 支持各种高度范围（1m ~ 10000m）

### 3. 数据导出

- ✅ 复制命令摘要时包含高度设置参数
- ✅ JSON 格式完整导出 `setAltitudeParam` 对象
- ✅ 便于后续数据分析和审计

## 显示效果

### 平台命令汇聚区域

当接收到高度设置命令时，在"平台命令汇聚"区域会显示：

```
时间                源地址              平台         命令
12:30:45          192.168.1.100      UAV_001     设置高度 (高度: 1500m)
```

### 命令详情

点击"详情"按钮后，会显示完整的命令数据：

```json
{
  "commandID": 1234567890,
  "platformName": "UAV_001",
  "command": 13,
  "setAltitudeParam": {
    "altitude": 1500
  }
}
```

### 命令摘要导出

点击"复制命令摘要"后，导出的 JSON 数据包含：

```json
{
  "平台命令统计": {
    "总数": 5,
    "命令类型数": 3,
    "持续时间": "15秒"
  },
  "最近命令": [
    {
      "时间": "12:30:45",
      "源地址": "192.168.1.100:9001",
      "平台": "UAV_001",
      "命令": "设置高度 (高度: 1500m)",
      "详细参数": {
        "altitude": 1500
      }
    }
  ]
}
```

## 协议定义

参考 `/Users/xinnix/code/afs/opEnd/src/protobuf/PlatformCmd.proto`:

```protobuf
enum PlatformCommand {
  Uav_Set_Altitude = 13; //设定无人机高度
}

message PlatformCmd {
  optional SetAltitudeparam setAltitudeParam = 12; //高度设定参数
}

message SetAltitudeparam {
  optional double altitude = 1;
}
```

## 测试验证

创建了测试脚本 `/Users/xinnix/code/afs/opEnd/testScipt/test-altitude-multicast-display.js`

### 测试覆盖

✅ **测试 1**: 命令名称映射正确性  
✅ **测试 2**: 高度设置命令报文创建  
✅ **测试 3**: 报文编码和解码  
✅ **测试 4**: 组播页面显示格式模拟  
✅ **测试 5**: 命令摘要导出模拟  
✅ **测试 6**: 不同高度值测试（1m、100m、1000m、5000m、10000m）

### 测试结果

```
✅ 所有测试通过！高度设置命令在组播页面中可以正确显示。
```

### 运行测试

```bash
cd /Users/xinnix/code/afs/opEnd
node testScipt/test-altitude-multicast-display.js
```

## 使用场景

### 场景 1：实时监控高度设置命令

当调试席位在组播页面监听网络流量时：

1. 无人机操作员在 UavOperationPage 点击"高度设置"按钮
2. 设置目标高度为 1500 米
3. 点击确定发送命令
4. 调试席位的组播页面实时显示：`设置高度 (高度: 1500m)`

### 场景 2：命令审计和回放

1. 开启组播监听记录所有命令
2. 复制命令摘要导出 JSON 数据
3. 分析历史命令中的高度设置记录
4. 验证命令执行序列的正确性

### 场景 3：系统调试和故障排查

1. 发现无人机高度异常
2. 查看组播页面的高度设置命令历史
3. 确认是否收到了正确的高度设置指令
4. 对比命令参数和实际执行结果

## 与其他命令的一致性

本次修改遵循了组播页面现有的命令处理模式：

| 命令类型     | 命令编号 | 显示名称     | 参数显示格式                  |
| ------------ | -------- | ------------ | ----------------------------- |
| 速度设置     | 9        | 设置速度     | `(速度: XXm/s)`               |
| 锁定目标     | 10       | 锁定目标     | `(锁定: 目标名)`              |
| 打击协同     | 11       | 打击协同     | `(火炮: XX, 目标: XX, ...)`   |
| 发射协同     | 12       | 发射协同     | `(无人机: XX, 目标: XX, ...)` |
| **高度设置** | **13**   | **设置高度** | **`(高度: XXm)`**             |

## 技术亮点

1. **统一的显示风格**: 与速度设置命令保持一致的参数显示格式
2. **完整的数据流**: 从命令名称映射 → 详细信息显示 → 摘要导出，全链路支持
3. **灵活的扩展性**: 为后续添加其他命令类型提供了清晰的模板
4. **完善的测试**: 创建了独立的测试脚本验证所有功能点

## 相关文件

- **主要修改**:

  - `/Users/xinnix/code/afs/opEnd/src/renderer/views/pages/MulticastPage.vue`

- **协议定义**:

  - `/Users/xinnix/code/afs/opEnd/src/protobuf/PlatformCmd.proto`

- **测试脚本**:

  - `/Users/xinnix/code/afs/opEnd/testScipt/test-altitude-multicast-display.js`

- **相关页面**:
  - `/Users/xinnix/code/afs/opEnd/src/renderer/views/pages/UavOperationPage.vue` (发送高度设置命令)

## 实现时间

2025-10-15

---

**功能已完成并通过测试** ✅
