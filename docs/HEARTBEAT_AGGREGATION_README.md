# 心跳包汇聚功能说明

## 🎯 功能概述

为了解决心跳包过多导致刷屏、影响查看其他重要数据包的问题，新增了心跳包汇聚显示功能。

## 📊 功能特点

### 1. 自动识别心跳包
- 自动识别包类型为 `0x02` (PackType_HeartbeatInternal) 的数据包
- 心跳包不会出现在主数据包列表中，避免刷屏

### 2. 汇聚显示区域
在主数据包列表上方显示一个专门的心跳包汇聚区域，包含：

#### 统计信息
- **总心跳数**: 接收到的心跳包总数量
- **频率/分钟**: 心跳包的接收频率
- **来源数**: 发送心跳包的不同源IP数量
- **持续时间**: 从第一个心跳包到最新心跳包的时间跨度

#### 操作按钮
- **复制心跳摘要**: 复制心跳包的统计信息
- **清空心跳**: 清空所有心跳包记录
- **显示/隐藏详情**: 切换心跳包详细列表的显示

### 3. 详细列表 (可折叠)
- 显示最近的20个心跳包
- 包含时间、源IP、软件ID、状态等信息
- 每个心跳包都有独立的复制按钮

### 4. 控制开关
- **显示心跳/隐藏心跳**: 控制是否显示心跳包汇聚区域
- **自动滚动**: 控制主列表是否自动滚动到底部

## 🎨 界面布局

```
┌─────────────────────────────────────────────────────────┐
│                    配置区域                              │
├─────────────────────────────────────────────────────────┤
│                    状态显示                              │
│  [监听状态] [地址] [端口] [总包数] [已解析] [平台状态] [心跳包] │
├─────────────────────────────────────────────────────────┤
│  💓 心跳包汇聚 (25个) [最新: 14:30:25]                   │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ [25总数] [12.5频率] [2来源] [2分30秒持续]             │ │
│  │ [复制摘要] [清空] [显示详情▼]                        │ │
│  │                                                     │ │
│  │ 📋 最近心跳包:                                       │ │
│  │ • 14:30:25 192.168.1.100 软件ID:1 状态:1 [📋]       │ │
│  │ • 14:30:23 192.168.1.101 软件ID:2 状态:1 [📋]       │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                 接收到的数据包                            │
│  [自动滚动] [显示心跳] [批量复制▼] [导出数据]              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 📦 飞行状态包 #1                                     │ │
│  │ 📦 平台状态包 #2                                     │ │
│  │ 📦 飞行控制包 #3                                     │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 🔧 技术实现

### 数据分离
```javascript
// 心跳包单独存储
const heartbeatPackets = ref<MulticastPacket[]>([]);

// 主列表排除心跳包
const displayPackets = computed(() => {
  return packets.value.filter(p => p.parsedPacket?.packageType !== 0x02);
});

// 数据包处理
const handlePacket = (packet: MulticastPacket) => {
  if (packet.parsedPacket?.packageType === 0x02) {
    heartbeatPackets.value.push(packet); // 心跳包
  } else {
    packets.value.push(packet); // 其他数据包
  }
};
```

### 内存管理
- 心跳包数量限制在1000个，超出时保留最新的500个
- 避免长时间运行导致内存占用过多

### 统计计算
```javascript
// 心跳频率计算
const getHeartbeatRate = () => {
  const durationMinutes = (lastTime - firstTime) / (1000 * 60);
  return (heartbeatPackets.length / durationMinutes).toFixed(1);
};

// 来源统计
const getUniqueHeartbeatSources = () => {
  return [...new Set(heartbeatPackets.map(p => extractSourceIP(p.source)))];
};
```

## 📋 心跳包摘要格式

```json
{
  "心跳包统计": {
    "总数": 25,
    "频率": "12.5/分钟",
    "来源数": 2,
    "持续时间": "2分30秒",
    "来源列表": ["192.168.1.100", "192.168.1.101"]
  },
  "最近心跳": [
    {
      "时间": "2024/1/15 14:30:25",
      "源地址": "192.168.1.100:56162",
      "软件ID": 1,
      "状态": 1
    }
  ],
  "统计时间": "2024/1/15 14:30:26"
}
```

## 🧪 测试方法

使用提供的测试脚本验证功能：

```bash
# 运行心跳包测试
node testScipt/test-heartbeat-packets.js
```

测试脚本会：
- 每2秒发送1-3个心跳包
- 偶尔发送飞行状态包
- 模拟多个软件ID和不同状态
- 运行10秒后自动停止

## 💡 使用建议

### 1. 日常监控
- 保持心跳包汇聚区域显示，监控系统健康状态
- 通过心跳频率判断系统是否正常运行
- 关注来源数量变化，及时发现设备上下线

### 2. 问题排查
- 心跳包异常时，展开详细列表查看具体信息
- 复制心跳摘要用于问题报告
- 结合其他数据包分析系统整体状态

### 3. 性能优化
- 定期清空心跳包记录，避免占用过多内存
- 根据需要调整心跳包显示开关
- 在高频心跳环境下，考虑隐藏详细列表

## ⚠️ 注意事项

1. **内存管理**: 长时间运行时注意清空心跳包记录
2. **网络负载**: 高频心跳可能影响网络性能
3. **显示性能**: 大量心跳包时建议隐藏详细列表
4. **数据完整性**: 心跳包仍会被包含在导出和统计中

## 🔄 更新日志

- **v1.0**: 基础心跳包汇聚功能
- **v1.1**: 添加统计信息和频率计算
- **v1.2**: 优化内存管理和性能
- **v1.3**: 添加详细列表和复制功能