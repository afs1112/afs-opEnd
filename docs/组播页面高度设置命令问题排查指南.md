# 组播页面高度设置命令 setAltitudeParam 字段缺失问题排查

## 问题描述

用户反馈：在组播页面看到的高度设置命令中，没有包含 `setAltitudeParam` 字段。

## 问题分析

根据端到端测试验证，Protobuf 编码和解码功能是**完全正常**的：

```
✅ 端到端测试通过！高度设置命令可以正确编码和解码。
  ✅ 方法1: setAltitudeParam 字段正确
  ✅ 方法2: setAltitudeParam 字段正确
```

因此，问题可能出在以下几个方面：

## 可能原因

### 原因 1：查看的是旧命令 ⭐ 最可能

**问题描述**：  
组播页面显示的高度设置命令是在添加 `setAltitudeParam` 支持**之前**发送的。

**验证方法**：

1. 重新启动系统（清空所有缓存的命令）
2. 在无人机操作页面点击"高度设置"按钮
3. 设置高度为 1500 米
4. 点击"确定"发送命令
5. 在组播页面查看最新接收到的高度设置命令

**解决方案**：  
在组播页面点击"清空命令"按钮，然后重新发送高度设置命令。

### 原因 2：系统未重启

**问题描述**：  
修改代码后，Electron 应用没有重新编译和重启。

**验证方法**：
查看终端日志中是否有以下输出：

```
[Parser] ✈️ 检测到高度设置命令
[Parser] ✈️ 高度设置参数: {
  "altitude": 1500
}
```

**解决方案**：

1. 停止当前运行的应用
2. 重新编译：`npm run build` 或 `npm run dev`
3. 重新启动应用

### 原因 3：发送端未传递参数

**问题描述**：  
无人机操作页面发送命令时，`setAltitudeParam` 参数未正确传递。

**验证方法**：
查看主进程日志中是否有：

```
[MulticastSender] 添加setAltitudeParam: { altitude: 1500 }
```

**解决方案**：
检查 [`UavOperationPage.vue`](file:///Users/xinnix/code/afs/opEnd/src/renderer/views/pages/UavOperationPage.vue) 中的 `sendSetAltitudeCommand` 函数，确认参数正确传递：

```typescript
const commandData = {
  commandID: Date.now(),
  platformName: connectedPlatformName.value,
  command: commandEnum,
  setAltitudeParam: {
    // ✅ 确认这行存在
    altitude: Number(setAltitudeForm.altitude), // ✅ 确认传递了高度值
  },
};
```

### 原因 4：Protobuf 加载失败

**问题描述**：  
`SetAltitudeparam` 类型未能正确加载，导致参数被忽略。

**验证方法**：
查看主进程日志中是否有：

```
[MulticastSender] ✅ 找到 SetAltitudeParamType
```

如果看到：

```
[MulticastSender] ⚠️ 未找到 SetAltitudeParamType: ...
[MulticastSender] ⚠️ setAltitudeParam数据存在但SetAltitudeParamType未找到，跳过
```

说明 Protobuf 类型加载失败。

**解决方案**：

1. 确认 [`PlatformCmd.proto`](file:///Users/xinnix/code/afs/opEnd/src/protobuf/PlatformCmd.proto) 中存在 `SetAltitudeparam` 定义
2. 重新编译 Protobuf 文件
3. 重启应用

## 排查步骤

### 步骤 1：清空组播页面的旧命令

1. 打开调试席位
2. 进入"设置与测试"标签（组播页面）
3. 找到"平台命令汇聚"区域
4. 点击"清空命令"按钮

### 步骤 2：重新发送高度设置命令

1. 打开无人机席位或火炮席位
2. 连接到平台（例如 UAV_001）
3. 找到"高度设置"按钮（绿色按钮，在速度设置旁边）
4. 点击"高度设置"
5. 在弹窗中输入高度：**1500** 米
6. 点击"确定"

### 步骤 3：查看组播页面

1. 切换到调试席位的组播页面
2. 在"平台命令汇聚"区域应该能看到最新的命令
3. 显示应该是：`设置高度 (高度: 1500m)`
4. 点击"详情"按钮

### 步骤 4：验证完整数据

在详情弹窗中，应该看到类似以下的 JSON 数据：

```json
{
  "commandID": 1760502983033,
  "platformName": "UAV_001",
  "command": 13,
  "setAltitudeParam": {
    "altitude": 1500
  }
}
```

✅ 如果看到 `setAltitudeParam` 字段，说明一切正常！  
❌ 如果仍然没有 `setAltitudeParam` 字段，继续下一步。

### 步骤 5：检查控制台日志

打开开发者工具（按 F12 或 Cmd+Option+I），查看控制台输出：

#### 主进程日志

应该看到：

```
[MulticastSender] ✅ 找到 SetAltitudeParamType
[MulticastSender] 添加setAltitudeParam: { altitude: 1500 }
[MulticastSender] 创建PlatformCmd消息: {...}
```

#### 渲染进程日志（组播页面）

应该看到：

```
[Parser] ✈️ 检测到高度设置命令
[Parser] ✈️ 高度设置参数: {
  "altitude": 1500
}
```

### 步骤 6：运行测试脚本

在终端运行以下命令：

```bash
cd /Users/xinnix/code/afs/opEnd
node testScipt/test-altitude-end-to-end.js
```

应该看到：

```
✅ 端到端测试通过！高度设置命令可以正确编码和解码。
```

如果测试失败，说明 Protobuf 配置有问题。

## 已验证的正确性

### ✅ Protobuf 协议定义正确

```protobuf
// PlatformCmd.proto
enum PlatformCommand {
  Uav_Set_Altitude = 13; //设定无人机高度
}

message PlatformCmd {
  optional SetAltitudeparam setAltitudeParam = 12; //高度设定参数
}

message SetAltitudeparam {
  optional double altitude = 1;
}
```

### ✅ 发送端代码正确

[`UavOperationPage.vue`](file:///Users/xinnix/code/afs/opEnd/src/renderer/views/pages/UavOperationPage.vue#L3259-L3300)

```typescript
const commandData = {
  commandID: Date.now(),
  platformName: connectedPlatformName.value,
  command: commandEnum,
  setAltitudeParam: {
    altitude: Number(setAltitudeForm.altitude),
  },
};
```

### ✅ 组播发送服务正确

[`multicast-sender.service.ts`](file:///Users/xinnix/code/afs/opEnd/src/main/services/multicast-sender.service.ts#L475-L486)

```typescript
if (data.setAltitudeParam && SetAltitudeParamType) {
  console.log("[MulticastSender] 添加setAltitudeParam:", data.setAltitudeParam);
  const setAltitudeParam = SetAltitudeParamType.create({
    altitude: data.setAltitudeParam.altitude || 100,
  });
  cmdData.setAltitudeParam = setAltitudeParam;
}
```

### ✅ 接收端解析正确

[`protobuf-parser.service.ts`](file:///Users/xinnix/code/afs/opEnd/src/main/services/protobuf-parser.service.ts#L695-L708)

```typescript
// 增加高度设置命令的特殊日志记录
if (
  decodedObject.command === "Uav_Set_Altitude" ||
  decodedObject.command === 13
) {
  console.log("[Parser] ✈️ 检测到高度设置命令");
  if (decodedObject.setAltitudeParam) {
    console.log(
      "[Parser] ✈️ 高度设置参数:",
      JSON.stringify(decodedObject.setAltitudeParam, null, 2)
    );
  } else {
    console.warn("[Parser] ⚠️ 高度设置命令但未找到 setAltitudeParam 字段");
  }
}
```

### ✅ 组播页面显示正确

[`MulticastPage.vue`](file:///Users/xinnix/code/afs/opEnd/src/renderer/views/pages/MulticastPage.vue#L1280-L1289)

```typescript
// 高度设置参数 (13)
if (command === 13 && parsedData.setAltitudeParam?.altitude !== undefined) {
  return ` (高度: ${parsedData.setAltitudeParam.altitude}m)`;
}
```

### ✅ 端到端测试通过

测试脚本：[`test-altitude-end-to-end.js`](file:///Users/xinnix/code/afs/opEnd/testScipt/test-altitude-end-to-end.js)

测试结果：

```
✅ 方法1: setAltitudeParam 字段正确
✅ 方法2: setAltitudeParam 字段正确
✅ 端到端测试通过！
```

## 最可能的原因

根据以上分析，**最可能的原因是你在组播页面看到的是旧的高度设置命令**，这些命令是在添加 `setAltitudeParam` 支持之前发送的。

## 建议操作

1. **清空旧命令**：在组播页面点击"清空命令"
2. **重新发送**：在无人机页面重新发送高度设置命令（高度 1500m）
3. **验证结果**：检查组播页面是否显示 `设置高度 (高度: 1500m)`
4. **查看详情**：点击详情查看是否包含 `setAltitudeParam` 字段

## 如果问题仍然存在

如果按照上述步骤操作后问题仍然存在，请提供以下信息：

1. **控制台日志**：主进程和渲染进程的完整日志
2. **详情截图**：组播页面高度设置命令的详情弹窗截图
3. **发送时间**：高度设置命令是什么时候发送的
4. **系统状态**：是否重启过系统

---

**创建时间**：2025-10-15  
**测试脚本**：`/Users/xinnix/code/afs/opEnd/testScipt/test-altitude-end-to-end.js`
