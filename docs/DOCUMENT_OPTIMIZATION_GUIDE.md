# 文档功能优化指南

## 📄 概述

本次优化显著改善了军事仿真系统中的文档打开和管理功能，提供了更好的用户体验和更强大的文档处理能力。

## 🎯 优化内容

### 1. 扩展的文档格式支持

- **Word 文档**: `.doc`, `.docx` (使用 mammoth 库)
- **Excel 文档**: `.xls`, `.xlsx` (使用 xlsx 库)
- **文本文件**: `.txt`
- **PDF 支持**: 预留接口，可后续扩展

### 2. 智能文档状态管理

- **隐藏而非关闭**: 关闭文档实际上是隐藏，保留在内存中
- **自动恢复**: 再次打开时直接显示最近文档，无需重新选择
- **状态持久化**: 文档路径、内容、类型等信息保存在内存中
- **多文档支持**: 支持同时管理多个已打开的文档

### 3. 改进的文档解析

- **Word 文档**: 提取原始文本 + HTML 格式化
- **Excel 文档**: 支持多工作表，自动分隔和标注
- **文本文件**: 保持原格式
- **HTML 转文本**: 智能转换保留基本格式

### 4. 用户界面优化

- **文档信息栏**: 显示文档类型、路径、缓存状态
- **智能按钮**: 根据状态调整按钮文本（"隐藏"/"关闭"）
- **图标显示**: 根据文档类型显示相应图标
- **错误处理**: 更友好的错误提示和重试机制

## 🚀 使用方法

### 基本使用流程

1. **首次打开文档**

   ```
   点击 "打开演练方案" → 选择文档 → 文档加载并显示
   ```

2. **再次打开文档**

   ```
   点击 "打开演练方案" → 直接显示最近文档（无需重新选择）
   ```

3. **隐藏文档**

   ```
   点击 "隐藏" → 文档界面关闭，但状态保留
   ```

4. **切换文档**
   ```
   在已打开文档的界面中 → 点击 "选择其他文档" → 选择新文档
   ```

### 高级功能

- **文档类型识别**: 自动识别并显示文档类型图标
- **缓存状态提示**: 显示文档是否来自缓存
- **格式化显示**: 根据文档类型优化显示格式

## 🔧 技术架构

### 服务架构

```
渲染进程 DocumentService
        ↓ (IPC 调用)
主进程 DocumentService + DocumentStateService
        ↓ (库调用)
mammoth (Word) / xlsx (Excel) / fs (Text)
```

### 关键组件

1. **主进程服务**

   - `DocumentService`: 文档解析和读取
   - `DocumentStateService`: 文档状态管理

2. **渲染进程服务**

   - `DocumentService`: 统一的文档操作接口

3. **IPC 通信**
   - `document:readDocument`: 读取文档
   - `document:getRecentDocument`: 获取最近文档
   - `document:hideDocument`: 隐藏文档
   - `document:hasOpenedDocuments`: 检查文档状态

## 📊 性能优化

- **内存缓存**: 已打开文档保存在内存中，避免重复读取
- **异步加载**: 所有文档操作都是异步的，不阻塞界面
- **错误处理**: 完善的错误捕获和用户提示机制
- **资源管理**: 支持清理缓存和状态重置

## 🛠️ 扩展指南

### 添加新文档格式

1. 在 `DocumentService.readDocument()` 中添加新格式检测
2. 创建对应的解析方法
3. 安装必要的解析库
4. 更新文档类型显示名称和图标

### 自定义文档处理

```typescript
// 扩展文档格式支持示例
case ".pdf":
  return await this.readPdfDocument(filePath);
```

## 🐛 故障排除

### 常见问题

1. **mammoth 库未安装**

   ```bash
   npm install mammoth
   ```

2. **xlsx 库未安装**

   ```bash
   npm install xlsx
   ```

3. **文档无法打开**
   - 检查文件路径是否正确
   - 确认文件格式是否支持
   - 查看控制台错误信息

### 调试模式

开启开发者工具查看详细日志：

```
[DocumentState] 保存文档状态: 文档.docx
[DocumentState] 显示最近文档: 文档.docx
[DocumentState] 隐藏文档: 文档.docx
```

## 📈 未来改进

- [ ] PDF 文档支持
- [ ] 文档预览缩略图
- [ ] 文档历史记录管理
- [ ] 文档内容搜索功能
- [ ] 文档注释和标记功能

---

**优化完成时间**: 2024-10-10  
**影响范围**: 火炮操作页面、无人机操作页面  
**兼容性**: 向后兼容，现有功能不受影响
