# 无人机页面任务目标显示时机修复总结

## 问题描述

在无人机操作页面（`UavOperationPage.vue`），任务目标卡片存在以下问题：

- **当前行为**：选择组别后，即使没有连接平台，任务目标就会显示
- **期望行为**：只有在点击"连接平台"按钮后，任务目标才应该显示

## 问题分析

### 原始代码逻辑

在 `getMissionTarget` 函数中（第 1607-1667 行），只检查了 `selectedGroup` 和 `platforms` 是否存在：

```typescript
const getMissionTarget = async () => {
  if (!selectedGroup.value || !platforms.value) {
    missionTarget.value = null;
    return;
  }
  // ... 查找并设置任务目标
};
```

### 调用时机

该函数在以下情况下会被调用：

1. **连接平台时**（第 3022 行、第 3085 行）- 这是正确的 ✓
2. **处理平台状态数据包时**（第 2170 行）- 这导致了问题 ✗

### 问题根源

当用户选择组别后，即使没有连接平台，只要收到平台状态数据包（0x29 类型），`getMissionTarget` 函数就会被调用，导致任务目标提前显示。

### 违反的项目规范

根据项目规范：

- **任务目标卡片空状态规范**：任务目标卡片必须始终显示，无目标时显示"未设置目标"
- **任务目标展示信息规范**：任务目标应包含目标名称、类型和坐标信息

问题在于：未连接时不应该有"任务目标"，应该一直显示"未设置目标"状态。

## 解决方案

### 修复策略

在 [`getMissionTarget`](file:///Users/xinnix/code/afs/opEnd/src/renderer/views/pages/UavOperationPage.vue#L1607-L1673) 函数开始处增加连接状态检查，确保只有在已连接状态下才获取并显示任务目标。

### 代码修改

修改位置：第 1607-1613 行

**修改前**：

```typescript
const getMissionTarget = async () => {
  if (!selectedGroup.value || !platforms.value) {
    missionTarget.value = null;
    return;
  }
  // ... 后续逻辑
};
```

**修改后**：

```typescript
const getMissionTarget = async () => {
  // 只有在已连接状态下才获取任务目标
  if (!isConnected.value) {
    missionTarget.value = null;
    return;
  }

  if (!selectedGroup.value || !platforms.value) {
    missionTarget.value = null;
    return;
  }
  // ... 后续逻辑
};
```

### 修改要点

1. ✅ **连接状态优先检查**：在所有其他检查之前先检查连接状态
2. ✅ **未连接时清空目标**：确保未连接时 `missionTarget.value = null`
3. ✅ **保持原有逻辑**：连接后的查找和显示逻辑保持不变
4. ✅ **添加注释说明**：清晰说明检查的目的

## 修复效果

### 行为变化对比

| 场景                 | 修复前          | 修复后              |
| -------------------- | --------------- | ------------------- |
| 选择组别（未连接）   | ❌ 显示任务目标 | ✅ 显示"未设置目标" |
| 选择组别并连接       | ✓ 显示任务目标  | ✓ 显示任务目标      |
| 连接后断开           | ✓ 清空目标      | ✓ 清空目标          |
| 收到数据包（未连接） | ❌ 显示任务目标 | ✅ 显示"未设置目标" |

### 用户体验改进

1. ✅ **逻辑清晰**：只有连接后才显示任务目标，符合业务逻辑
2. ✅ **状态一致**：未连接状态下始终显示"未设置目标"
3. ✅ **操作可控**：用户明确知道连接后才会获得任务目标
4. ✅ **符合规范**：遵循项目规范中任务目标卡片的空状态展示要求

## 测试验证

### 自动化验证

执行测试脚本：

```bash
node test-mission-target-display-timing-fix.js
```

验证结果：**4/4 项检查通过** ✓

### 手动测试步骤

#### 测试 1：未连接时的行为

1. 启动应用
2. 在下拉框中选择分组（如"红 1 组"）
3. **验证点**：任务目标卡片显示警告图标和"未设置目标"文字 ✓
4. 等待数据包到达（观察控制台）
5. **验证点**：任务目标卡片仍然显示"未设置目标" ✓

#### 测试 2：连接后的行为

1. 在下拉框中选择无人机
2. 点击"连接平台"按钮
3. **验证点**：任务目标卡片显示实际的任务目标信息 ✓
   - 显示目标名称、类型
   - 显示经纬高坐标
   - 显示目标图片（如有）
   - 显示目标状态标签

#### 测试 3：断开连接的行为

1. 在已连接状态下
2. 点击"断开"按钮
3. **验证点**：任务目标卡片恢复显示"未设置目标" ✓

#### 测试 4：重新连接的行为

1. 断开连接后
2. 重新选择无人机并连接
3. **验证点**：任务目标卡片再次显示任务目标信息 ✓

## 相关文件

### 修改文件

- [`/src/renderer/views/pages/UavOperationPage.vue`](file:///Users/xinnix/code/afs/opEnd/src/renderer/views/pages/UavOperationPage.vue)
  - L1607-1613: 在 `getMissionTarget` 函数中添加连接状态检查

### 测试文件

- [`/test-mission-target-display-timing-fix.js`](file:///Users/xinnix/code/afs/opEnd/test-mission-target-display-timing-fix.js) - 自动化验证脚本

## 影响范围分析

### 受影响的功能

1. ✅ **任务目标卡片显示**：按预期行为显示
2. ✅ **连接/断开操作**：正常工作，无副作用
3. ✅ **数据包处理**：正常接收和处理，不影响其他数据更新

### 不受影响的功能

1. ✅ **目标选择下拉框**：从 `tracks` 字段动态加载，独立于任务目标
2. ✅ **发现目标列表**：中间面板的目标状态卡片，独立更新
3. ✅ **协同报文功能**：正常发送和接收
4. ✅ **平台状态显示**：正常更新位置、姿态等信息

## 相关项目规范

本次修复遵循以下项目规范：

### 任务目标卡片空状态规范

> 任务目标卡片必须始终显示，无论连接状态或是否有目标；无目标时显示居中警告图标（32px）和斜体文字'未设置目标'，最小高度保持 80px。

**实现情况**：✅ 未连接时始终显示空状态

### 任务目标展示信息规范

> 任务目标展示必须包含目标名称、目标类型和经纬高坐标信息

**实现情况**：✅ 连接后正确显示所有必需信息

### 目标选择动态数据源规范

> 目标选择功能应从当前连接平台的 tracks 字段动态加载目标数据

**实现情况**：✅ 与任务目标独立，不受此修复影响

## 技术要点

### 状态管理

- `isConnected.value`：连接状态标志
- `missionTarget.value`：任务目标数据对象
- `selectedGroup.value`：选择的组别

### 检查顺序

1. **第一优先级**：连接状态（`!isConnected.value`）
2. **第二优先级**：组别和平台数据（`!selectedGroup.value || !platforms.value`）
3. **第三优先级**：具体的平台查找逻辑

### 空值处理

未连接或无数据时，统一设置 `missionTarget.value = null`，触发 UI 显示空状态。

## 注意事项

1. **不影响数据接收**：即使未连接，平台数据包仍正常接收和处理
2. **不影响其他目标功能**：发现目标列表、目标选择下拉框独立工作
3. **保持 UI 一致性**：任务目标卡片始终显示，只是内容根据连接状态变化
4. **断开时自动清理**：断开连接时会在 `handleConnectPlatform` 中清空 `missionTarget.value`

## 总结

本次修复通过在 `getMissionTarget` 函数中增加连接状态检查，确保任务目标只在连接后才显示，解决了选择组别后任务目标提前显示的问题。修复遵循项目规范，不影响其他功能，提升了用户体验和逻辑一致性。

**核心改进**：

- ✅ 连接前显示"未设置目标"
- ✅ 连接后显示实际任务目标
- ✅ 断开后恢复"未设置目标"
- ✅ 逻辑清晰，符合用户预期
