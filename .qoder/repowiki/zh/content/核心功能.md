# 核心功能

<cite>
**本文档中引用的文件**   
- [multicast.service.ts](file://src/main/services/multicast.service.ts)
- [protobuf-parser.service.ts](file://src/main/services/protobuf-parser.service.ts)
- [db.service.ts](file://src/main/database/db.service.ts)
- [preload.ts](file://src/main/preload.ts)
- [main.ts](file://src/main/main.ts)
- [MulticastPage.vue](file://src/renderer/views/pages/MulticastPage.vue)
- [PlatformStatus.proto](file://src/protobuf/PlatformStatus.proto)
- [PublicStruct.proto](file://src/protobuf/PublicStruct.proto)
- [multicast-sender.service.ts](file://src/main/services/multicast-sender.service.ts) - *最近提交中新增*
- [ArtilleryOperationPage.vue](file://src/renderer/views/pages/ArtilleryOperationPage.vue) - *最近提交中新增*
- [PlatformCmd.proto](file://src/protobuf/PlatformCmd.proto) - *最近提交中新增*
- [UavOperationPage.vue](file://src/renderer/views/pages/UavOperationPage.vue) - *最近提交中新增*
- [artillery-group-selection-feature.md](file://artillery-group-selection-feature.md) - *最近提交中新增*
</cite>

## 更新摘要
**已做更改**   
- 在UDP组播监听部分增加了对组播发送服务的说明
- 新增了“组播发送服务”章节，详细描述火炮控制命令的发送功能
- 更新了进程间通信机制，增加了发送PlatformCmd命令的IPC处理
- 扩展了前端数据展示部分，增加了火炮操作页面的实现细节
- 更新了功能协作流程图，包含命令发送的完整闭环
- 所有文件引用均已更新，包含新添加的文件
- **新增源IP与端口分离显示功能**：在前端页面中将数据包源信息的IP地址和端口号分离显示，提升用户体验
- **新增火炮分组选择功能**：在火炮操作页面实现了基于平台状态数据的分组选择功能，用户可选择分组后筛选对应火炮
- **新增无人机传感器转向功能**：在无人机操作页面增加了传感器转向控制，支持方位角和俯仰角参数设置

## 目录
1. [核心功能](#核心功能)
2. [UDP组播监听](#udp组播监听)
3. [Protobuf协议解析](#protobuf协议解析)
4. [数据管理与持久化](#数据管理与持久化)
5. [进程间通信机制](#进程间通信机制)
6. [前端数据展示](#前端数据展示)
7. [组播发送服务](#组播发送服务)
8. [功能协作流程](#功能协作流程)

## UDP组播监听

`MulticastService` 类实现了基于 `dgram` 模块的 UDP 组播监听功能，通过继承 `EventEmitter` 实现事件驱动架构，支持数据接收与事件分发。该服务在启动时会自动加载 Protobuf 定义文件，并监听指定的组播地址和端口。

服务通过 `start()` 方法启动监听，内部创建 UDP 套接字并绑定到配置的组播地址（默认为 `239.255.43.21`）和端口（默认为 `10086`）。当收到数据包时，触发 `message` 事件，对原始数据进行初步校验（检查包头 `0xAA55` 和最小长度 8 字节），然后尝试使用 `protobufParserService` 解析数据。

解析后的数据封装为 `MulticastPacket` 对象，包含时间戳、来源地址、原始数据和解析结果等信息，并通过 `emit('packet', packet)` 事件分发给所有监听者。同时，服务还提供了错误处理机制，当套接字发生错误时，通过 `emit('error', err)` 事件向外抛出。

```
classDiagram
class MulticastService {
+socket : dgram.Socket
+isListening : boolean
+multicastAddress : string
+multicastPort : number
+interfaceAddress : string
+start() : Promise~void~
+stop() : Promise~void~
+getStatus() : object
+updateConfig(address, port, interfaceAddr) : void
}
class EventEmitter {
+on(event, listener)
+emit(event, data)
+removeListener(event, listener)
}
class MulticastPacket {
+timestamp : number
+source : string
+data : Buffer
+dataString : string
+size : number
+parsedPacket : ParsedPacket
}
MulticastService --> EventEmitter : "继承"
MulticastService --> MulticastPacket : "生成"
MulticastService --> ProtobufParserService : "依赖"
```

**本节来源**
- [multicast.service.ts](file://src/main/services/multicast.service.ts#L1-L180)

## Protobuf协议解析

`ProtobufParserService` 类负责动态加载 `.proto` 文件并解析二进制流。该服务使用 `protobufjs` 库实现 Protobuf 消息的编解码功能，支持多种无人机相关协议类型。

服务在初始化时通过 `loadProtobufDefinitions()` 方法动态加载 `PublicStruct.proto` 和 `PlatformStatus.proto` 等定义文件。方法会尝试多个可能的路径（生产环境、开发环境、当前工作目录等）来定位 `protobuf` 目录，确保在不同环境下都能正确加载。

解析过程由 `parsePacket()` 方法实现，首先校验数据包格式（包头 `0xAA55`、协议ID、包类型、数据长度等），然后根据包类型（`packageType`）调用相应的解析方法。服务维护了一个 `packageTypes` 映射表，将十六进制类型码映射为可读的名称（如 `0x29` 对应 `PackType_PlatformStatus`）。

对于平台状态数据（`0x29`），服务会调用 `parsePlatformStatus()` 方法，通过 `root.lookupType('PlatformStatus.PlatformStatusInfo')` 查找消息类型并解码。解码结果包含平台ID、平台类型和地理坐标等结构化信息。

```
sequenceDiagram
participant 接收数据
participant ProtobufParser
participant Proto文件
participant 解析结果
接收数据->>ProtobufParser : parsePacket(data, source, timestamp)
ProtobufParser->>ProtobufParser : 校验包头(0xAA55)和长度
alt Protobuf定义未加载
ProtobufParser-->>接收数据 : 返回null
else 成功加载
ProtobufParser->>ProtobufParser : 提取protocolID和packageType
ProtobufParser->>ProtobufParser : 计算实际数据长度
ProtobufParser->>Proto文件 : 根据packageType查找消息类型
Proto文件-->>ProtobufParser : 返回Type对象
ProtobufParser->>ProtobufParser : 调用decode()解码数据
ProtobufParser-->>解析结果 : 返回ParsedPacket对象
end
```

**本节来源**
- [protobuf-parser.service.ts](file://src/main/services/protobuf-parser.service.ts#L1-L458)
- [PlatformStatus.proto](file://src/protobuf/PlatformStatus.proto#L1-L28)
- [PublicStruct.proto](file://src/protobuf/PublicStruct.proto#L1-L55)

## 数据管理与持久化

`DBService` 类利用 `better-sqlite3` 实现数据持久化，采用 SQLite 数据库存储应用数据。服务在用户数据目录下创建 `app-database.sqlite` 文件作为数据库存储位置。

服务实现了完整的数据库迁移和种子数据管理机制。通过 `applyMigrations()` 方法执行 `migrations` 目录下的迁移脚本（如 `001-initial-schema.js`），实现数据库模式的版本控制。通过 `runSeeds()` 方法执行 `seeds` 目录下的种子脚本（如 `001-sample-data.js`），初始化示例数据。

数据库连接通过 `get db()` 属性暴露，供其他模块使用。服务还配置了 `WAL`（Write-Ahead Logging）模式以提高并发性能，并启用外键约束确保数据完整性。

```
classDiagram
class DBService {
-dbInstance : Database
-migrationsPath : string
-seedsPath : string
+initializeDatabase() : void
+applyMigrations() : Promise~void~
+runSeeds() : Promise~void~
+get db() : Database
}
class Database {
+prepare(sql) : Statement
+exec(sql) : void
+pragma(statement) : void
+transaction(fn) : Function
}
class Statement {
+all(params) : any[]
+run(params) : object
}
DBService --> Database : "使用"
DBService --> Statement : "使用"
```

**本节来源**
- [db.service.ts](file://src/main/database/db.service.ts#L1-L96)

## 进程间通信机制

系统通过 Electron 的 `contextBridge` 和 `ipcRenderer`/`ipcMain` 机制实现主进程与渲染进程之间的安全通信。`preload.ts` 文件通过 `contextBridge.exposeInMainWorld()` 向渲染进程暴露 `electronAPI` 接口。

在 `preload.ts` 中，`multicast` 对象暴露了 `start`、`stop`、`getStatus`、`updateConfig` 等方法，以及 `onPacket`、`onError` 等事件监听方法。这些方法通过 `ipcRenderer.invoke()` 调用主进程的 IPC 处理函数。

主进程在 `main.ts` 中通过 `ipcMain.handle()` 注册相应的处理函数。例如，`"multicast:start"` 事件调用 `multicastService.start()` 方法启动监听，并将结果返回给渲染进程。当 `multicastService` 接收到数据包时，通过 `BrowserWindow.webContents.send()` 将 `multicast:packet` 事件发送给所有渲染窗口。

新增的 `multicast:sendPlatformCmd` IPC 处理器允许渲染进程发送火炮控制命令。主进程会检查 `multicastSenderService` 是否已初始化，若未初始化则尝试重新初始化，然后调用 `sendPlatformCmd()` 方法发送命令。

```
sequenceDiagram
participant 渲染进程
participant preload
participant 主进程
participant MulticastService
渲染进程->>preload : window.electronAPI.multicast.start()
preload->>主进程 : ipcRenderer.invoke("multicast : start")
主进程->>主进程 : multicastService.start()
主进程-->>preload : 返回{success : true}
preload-->>渲染进程 : 返回结果
loop 数据接收
MulticastService->>主进程 : emit('packet', packet)
主进程->>主进程 : 遍历所有窗口
主进程->>渲染进程 : webContents.send('multicast : packet', packet)
渲染进程->>渲染进程 : 触发onPacket回调
end
loop 命令发送
渲染进程->>preload : window.electronAPI.multicast.sendPlatformCmd(data)
preload->>主进程 : ipcRenderer.invoke("multicast : sendPlatformCmd", data)
主进程->>主进程 : 检查并初始化multicastSenderService
主进程->>主进程 : multicastSenderService.sendPlatformCmd(data)
主进程-->>preload : 返回{success : true}
preload-->>渲染进程 : 返回结果
end
```

**本节来源**
- [preload.ts](file://src/main/preload.ts#L1-L59)
- [main.ts](file://src/main/main.ts#L40-L80)

## 前端数据展示

`MulticastPage.vue` 是渲染进程中的页面组件，负责展示实时接收到的组播数据。页面通过 `window.electronAPI.multicast.onPacket()` 监听数据包事件，将接收到的数据包添加到 `packets` 数组中。

页面分为三个主要区域：组播配置区、监听状态区和数据包列表区。配置区允许用户修改组播地址、端口和接口地址；状态区实时显示监听状态、总数据包数、已解析数据包数和平台状态数据包数；数据包列表区以结构化方式展示每个数据包的详细信息。

对于成功解析的数据包，页面会显示包类型、协议ID、数据大小等元信息，并特别突出显示平台状态信息（包含平台ID、类型、经纬度和高度）。未解析的数据包则显示原始十六进制数据，便于调试分析。

**重要更新**：根据最近的代码变更，页面增强了源IP和端口的分离显示功能。通过 `extractSourceIP` 和 `extractSourcePort` 两个辅助函数，将 `source` 字段（格式为 `IP:端口`）解析为独立的IP地址和端口号，并在数据包详情中分别显示。

```
flowchart TD
A[页面加载] --> B[设置事件监听]
B --> C[监听multicast:packet事件]
C --> D[监听multicast:error事件]
D --> E[加载初始配置]
E --> F[获取初始状态]
G[用户点击开始监听] --> H[调用electronAPI.multicast.updateConfig]
H --> I[调用electronAPI.multicast.start]
I --> J[更新页面状态]
K[收到数据包] --> L[添加到packets数组]
L --> M{是否自动滚动}
M --> |是| N[滚动到底部]
M --> |否| O[保持当前位置]
P[用户点击清空] --> Q[清空packets数组]
R[用户点击导出] --> S[调用exportFile导出JSON]
```

**本节来源**
- [MulticastPage.vue](file://src/renderer/views/pages/MulticastPage.vue#L1-L411)

## 组播发送服务

`MulticastSenderService` 类实现了UDP组播发送功能，专门用于发送火炮控制命令。该服务在 `main.ts` 中初始化，并通过IPC机制向渲染进程暴露发送接口。

服务通过 `initialize()` 方法初始化，创建UDP套接字并加载 `PlatformCmd.proto` 和 `PublicStruct.proto` 等Protobuf定义文件。初始化成功后，可通过 `sendPlatformCmd()` 方法发送平台控制命令。

`sendPlatformCmd()` 方法接收 `PlatformCmdData` 接口定义的数据，包括命令ID、平台名称、平台类型、命令类型和可选的发射参数。方法会查找 `PlatformStatus.PlatformCmd` 消息类型，编码Protobuf消息，并构造符合协议规范的数据包（包含包头 `0xAA55`、协议ID `0x01`、包类型 `0x2A` 和数据长度）。

数据包通过UDP套接字发送到组播地址 `239.255.43.21` 和端口 `10086`，与监听服务使用相同的通信通道，实现了双向通信能力。

```
sequenceDiagram
participant 火炮操作页面
participant preload
participant 主进程
participant MulticastSender
火炮操作页面->>preload : window.electronAPI.multicast.sendPlatformCmd(data)
preload->>主进程 : ipcRenderer.invoke("multicast : sendPlatformCmd", data)
主进程->>主进程 : 检查multicastSenderService初始化状态
alt 未初始化
主进程->>主进程 : 调用initialize()方法
else 已初始化
主进程->>主进程 : 继续执行
end
主进程->>MulticastSender : sendPlatformCmd(data)
MulticastSender->>MulticastSender : 查找PlatformCmd消息类型
MulticastSender->>MulticastSender : 编码Protobuf消息
MulticastSender->>MulticastSender : 构造完整数据包
MulticastSender->>MulticastSender : 发送UDP组播数据包
MulticastSender-->>主进程 : 返回成功
主进程-->>preload : 返回{success : true}
preload-->>火炮操作页面 : 返回结果
```

**本节来源**
- [multicast-sender.service.ts](file://src/main/services/multicast-sender.service.ts#L1-L255)
- [PlatformCmd.proto](file://src/protobuf/PlatformCmd.proto#L1-L39)

## 功能协作流程

系统的三大核心功能协同工作，形成从数据接收到存储再到前端展示的完整链条，新增的组播发送功能实现了控制命令的反向传输：

1. **数据接收**：`MulticastService` 监听 UDP 组播地址，接收二进制数据包
2. **协议解析**：`ProtobufParserService` 解析数据包，提取结构化信息
3. **事件分发**：`MulticastService` 通过 EventEmitter 发出 `packet` 事件
4. **进程通信**：主进程通过 IPC 将数据包转发给渲染进程
5. **前端展示**：`MulticastPage.vue` 接收数据并更新 UI
6. **数据存储**：可选地通过 `dbService` 将数据持久化到 SQLite 数据库
7. **命令发送**：`ArtilleryOperationPage.vue` 发送控制命令，通过 `MulticastSenderService` 发送组播数据

整个流程体现了清晰的分层架构和松耦合设计，各组件职责明确，通过标准化的接口进行通信，确保了系统的可维护性和可扩展性。

```
graph LR
A[UDP组播数据] --> B[MulticastService]
B --> C{是否有效包头}
C --> |是| D[ProtobufParserService]
C --> |否| E[原始数据显示]
D --> F{解析成功?}
F --> |是| G[结构化数据]
F --> |否| E
G --> H[emit('packet')]
H --> I[ipcMain.handle]
I --> J[webContents.send]
J --> K[MulticastPage.vue]
K --> L[UI展示]
G --> M[DBService]
M --> N[SQLite数据库]
O[火炮操作] --> P[ArtilleryOperationPage.vue]
P --> Q[electronAPI.multicast.sendPlatformCmd]
Q --> R[ipcMain.handle]
R --> S[MulticastSenderService]
S --> T[UDP组播发送]
T --> U[仿真系统]
```

**本节来源**
- [multicast.service.ts](file://src/main/services/multicast.service.ts#L1-L180)
- [protobuf-parser.service.ts](file://src/main/services/protobuf-parser.service.ts#L1-L458)
- [db.service.ts](file://src/main/database/db.service.ts#L1-L96)
- [preload.ts](file://src/main/preload.ts#L1-L59)
- [main.ts](file://src/main/main.ts#L40-L80)
- [MulticastPage.vue](file://src/renderer/views/pages/MulticastPage.vue#L1-L411)
- [multicast-sender.service.ts](file://src/main/services/multicast-sender.service.ts#L1-L255)
- [ArtilleryOperationPage.vue](file://src/renderer/views/pages/ArtilleryOperationPage.vue#L1-L361)
- [PlatformCmd.proto](file://src/protobuf/PlatformCmd.proto#L1-L39)