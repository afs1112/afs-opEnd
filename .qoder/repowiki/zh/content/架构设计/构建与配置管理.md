# 构建与配置管理

<cite>
**本文档引用的文件**  
- [vite.config.js](file://vite.config.js)
- [electron-builder.json](file://electron-builder.json)
- [package.json](file://package.json)
- [src/main/tsconfig.json](file://src/main/tsconfig.json)
- [src/renderer/tsconfig.json](file://src/renderer/tsconfig.json)
- [scripts/dev-server.js](file://scripts/dev-server.js)
- [scripts/build.js](file://scripts/build.js)
- [postcss.config.mjs](file://postcss.config.mjs)
- [config.env](file://config.env)
</cite>

## 目录
1. [项目构建流程概述](#项目构建流程概述)  
2. [Vite 配置分析](#vite-配置分析)  
3. [Electron 打包配置](#electron-打包配置)  
4. [TypeScript 编译配置对比](#typescript-编译配置对比)  
5. [npm 脚本与构建流程协调](#npm-脚本与构建流程协调)  
6. [自定义构建配置策略](#自定义构建配置策略)  

## 项目构建流程概述

本项目采用 Vite + Electron 的现代前端构建架构，实现跨平台桌面应用的快速开发与高效打包。整体构建流程分为开发模式与生产模式，分别由 `dev-server.js` 和 `build.js` 脚本驱动，协调 Vite 构建工具与 Electron 运行时的集成。

在开发阶段，通过 `npm run dev` 启动本地开发服务器，同时编译主进程代码并自动重启 Electron 实例，实现热重载体验。在生产阶段，通过 `npm run build` 执行完整的构建流程，包括渲染进程打包、主进程编译、资源复制及最终的 Electron 应用打包。

**Section sources**  
- [scripts/dev-server.js](file://scripts/dev-server.js#L0-L136)  
- [scripts/build.js](file://scripts/build.js#L0-L48)  

## Vite 配置分析

### 开发服务器与构建输出配置

`vite.config.js` 文件定义了渲染进程的构建行为，其核心配置如下：

```js
const config = defineConfig((mode) => {
  return {
    root: Path.join(__dirname, "src", "renderer"),
    publicDir: "public",
    server: {
      port: 8080,
    },
    open: false,
    build: {
      outDir: Path.join(__dirname, "build", "renderer"),
      emptyOutDir: true,
    },
    plugins: [
      vuePlugin(),
    ],
  };
});
```

- **根目录设置**：`root` 指向 `src/renderer`，明确渲染进程的源码入口。
- **开发服务器**：监听端口 `8080`，未启用自动打开浏览器（`open: false`）。
- **构建输出**：输出目录为 `build/renderer`，每次构建前清空目录（`emptyOutDir: true`）。
- **插件系统**：使用 `@vitejs/plugin-vue` 支持 Vue 3 单文件组件。

值得注意的是，当前配置中**未设置开发服务器代理**，所有网络请求将直接发送至目标地址。若需跨域请求，需在主进程或后端服务中处理。

### PostCSS 与 CSS 处理配置

项目通过 `postcss.config.mjs` 配置 PostCSS 插件链，支持现代化 CSS 特性：

```js
export default {
  plugins: {
    "@tailwindcss/postcss": {},
    autoprefixer: {},
    "postcss-apply": {},
  },
};
```

- **Tailwind CSS**：提供实用类驱动的样式系统。
- **Autoprefixer**：自动添加浏览器厂商前缀。
- **PostCSS Apply**：支持 `@apply` 语法复用样式规则。

该配置在 `package.json` 中被 Vite 自动识别，无需额外声明。

**Section sources**  
- [vite.config.js](file://vite.config.js#L0-L27)  
- [postcss.config.mjs](file://postcss.config.mjs#L0-L7)  

## Electron 打包配置

`electron-builder.json` 定义了应用的打包行为，关键配置如下：

```json
{
  "appId": "com.electron.app",
  "directories": {
    "output": "dist"
  },
  "nsis": {
    "oneClick": false,
    "perMachine": false,
    "allowToChangeInstallationDirectory": true,
    "shortcutName": "Electron App"
  },
  "win": {
    "target": "nsis"
  },
  "linux": {
    "target": ["snap"]
  },
  "files": [
    {
      "from": "build/main",
      "to": "main",
      "filter": ["**/*"]
    },
    {
      "from": "build/renderer",
      "to": "renderer",
      "filter": ["**/*"]
    },
    {
      "from": "src/main/static",
      "to": "static",
      "filter": ["**/*"]
    },
    {
      "from": "src/protobuf",
      "to": "main/src/protobuf",
      "filter": ["**/*"]
    },
    "!build",
    "!dist",
    "!scripts"
  ]
}
```

### 打包目标与平台配置

- **Windows**：使用 NSIS 安装程序，支持自定义安装路径，非一键安装。
- **Linux**：打包为 Snap 格式。
- **macOS**：默认使用 DMG 格式（未显式配置）。

### 文件包含策略

`files` 字段精确控制打包内容：
- 包含编译后的主进程代码（`build/main`）和渲染进程代码（`build/renderer`）。
- 包含静态资源（`src/main/static`）和 Protobuf 定义文件（`src/protobuf`）。
- 排除构建中间目录（`!build`, `!dist`）和脚本目录（`!scripts`），避免冗余。

**Section sources**  
- [electron-builder.json](file://electron-builder.json#L0-L44)  

## TypeScript 编译配置对比

### 主进程配置（src/main/tsconfig.json）

```json
{
  "compilerOptions": {
    "target": "ES2015",
    "module": "commonjs",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "../../build/main",
    "allowJs": true,
    "noImplicitAny": false
  },
  "exclude": ["static"]
}
```

- **模块系统**：使用 `commonjs`，兼容 Node.js 的 `require` 语法。
- **输出目录**：编译结果输出至 `build/main`。
- **Node.js 支持**：启用 `allowJs` 以支持混合 JS/TS 代码。
- **严格模式**：开启 `strict` 类型检查。

### 渲染进程配置（src/renderer/tsconfig.json）

```json
{
  "compilerOptions": {
    "target": "esnext",
    "useDefineForClassFields": true,
    "module": "esnext",
    "moduleResolution": "node",
    "strict": false,
    "jsx": "preserve",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "lib": ["esnext", "dom"],
    "skipLibCheck": true,
    "allowJs": true,
    "composite": true,
    "types": ["vite/client", "node"]
  }
}
```

- **浏览器环境**：`lib` 包含 `dom`，支持浏览器 API。
- **模块系统**：使用 `esnext`，兼容 Vite 的 ES 模块处理。
- **类型声明**：包含 `vite/client` 以支持 `.vue` 文件导入。
- **Node 类型支持**：尽管运行在浏览器，但仍包含 `node` 类型，可能用于预加载脚本通信。

### 差异原因分析

| 特性 | 主进程 | 渲染进程 | 原因 |
|------|--------|----------|------|
| `module` | `commonjs` | `esnext` | 主进程运行于 Node.js，使用 `require`；渲染进程由 Vite 处理，使用 ES 模块 |
| `lib` | 未显式指定 | `["esnext", "dom"]` | 渲染进程需访问 DOM API，主进程无需 |
| `types` | 未指定 | `["vite/client", "node"]` | 渲染进程需 Vite 类型支持，主进程直接使用 Node.js 内置类型 |
| `strict` | `true` | `false` | 主进程逻辑复杂，需严格类型检查；渲染进程以 Vue 组件为主，灵活性更高 |

**Section sources**  
- [src/main/tsconfig.json](file://src/main/tsconfig.json#L0-L14)  
- [src/renderer/tsconfig.json](file://src/renderer/tsconfig.json#L0-L18)  

## npm 脚本与构建流程协调

`package.json` 中的 `scripts` 字段定义了构建流程的入口：

```json
"scripts": {
  "dev": "node scripts/dev-server.js",
  "build": "node scripts/build.js && electron-builder",
  "build:win": "node scripts/build.js && electron-builder --win",
  "build:mac": "node scripts/build.js && electron-builder --mac",
  "build:linux": "node scripts/build.js && electron-builder --linux",
  "postinstall": "electron-rebuild -f -w better-sqlite3"
}
```

### 开发流程（dev）

1. 执行 `scripts/dev-server.js`
2. 启动 Vite 开发服务器（监听 `8080` 端口）
3. 编译主进程 TypeScript 代码
4. 启动 Electron 实例，指向编译后的 `main.js`
5. 监听主进程文件变化，自动重启 Electron

该流程实现了主进程代码修改后的热重载，提升开发效率。

### 生产构建流程（build）

1. 执行 `scripts/build.js`
2. 并行执行 `buildRenderer()` 和 `buildMain()`
   - `buildRenderer()`：调用 Vite 构建渲染进程
   - `buildMain()`：调用 `tsc` 编译主进程
3. 构建完成后，自动复制 `src/protobuf` 到 `build/main/src/protobuf`
4. 执行 `electron-builder`，根据平台打包应用

平台专用脚本（如 `build:win`）允许指定目标平台，便于 CI/CD 流水线使用。

**Section sources**  
- [package.json](file://package.json#L0-L42)  
- [scripts/dev-server.js](file://scripts/dev-server.js#L0-L136)  
- [scripts/build.js](file://scripts/build.js#L0-L48)  

## 自定义构建配置策略

### 环境变量注入

项目通过 `dotenv` 实现环境变量管理，具体流程如下：

1. 创建 `config.env` 文件存储配置：
   ```
   MULTICAST_ADDRESS=239.255.43.21
   MULTICAST_PORT=10086
   INTERFACE_ADDRESS=0.0.0.0
   NODE_ENV=development
   ```

2. 在主进程代码中加载：
   ```js
   const dotenv = require('dotenv');
   const path = require('path');
   dotenv.config({ path: path.join(__dirname, 'config.env') });
   ```

3. 通过 IPC 通信将配置传递给渲染进程，避免前端暴露敏感信息。

测试文件（如 `test-main-config.js`）验证了该机制的正确性。

### 条件编译

可通过 `mode` 参数在 `vite.config.js` 中实现条件配置：

```js
defineConfig((mode) => {
  if (mode === 'development') {
    // 开发专用配置
  } else {
    // 生产专用配置
  }
});
```

### 资源优化策略

1. **代码分割**：Vite 默认支持动态导入的代码分割。
2. **静态资源处理**：大文件可移至 `public` 目录，避免打包。
3. **Protobuf 优化**：当前将 `.proto` 文件直接复制，可考虑编译为 JS 以减少体积。
4. **依赖分析**：使用 `vite-bundle-visualizer` 分析包体积，优化第三方依赖。

**Section sources**  
- [config.env](file://config.env#L0-L6)  
- [test-main-config.js](file://test-main-config.js#L0-L24)  
- [scripts/build.js](file://scripts/build.js#L0-L48)