# 组播监听功能使用说明

## 功能概述

这个设备模拟操作端应用现在支持监听组播地址和端口的数据包，并实时显示接收到的数据。应用还集成了protobuf解析功能，能够自动解析和显示结构化的无人机通信数据。

## 配置说明

### 环境配置文件

在项目根目录的 `config.env` 文件中配置组播参数：

```env
# 组播配置
MULTICAST_ADDRESS=224.0.0.1
MULTICAST_PORT=8888
INTERFACE_ADDRESS=0.0.0.0

# 应用配置
NODE_ENV=development
```

### 配置参数说明

- `MULTICAST_ADDRESS`: 组播地址，默认为 `224.0.0.1`
- `MULTICAST_PORT`: 组播端口，默认为 `8888`
- `INTERFACE_ADDRESS`: 网络接口地址，默认为 `0.0.0.0`（监听所有接口）

## 使用方法

### 1. 启动应用

```bash
npm run dev
```

### 2. 访问组播监听页面

在应用界面中，点击 "组播监听" 标签页。

### 3. 配置和启动监听

1. 在配置区域设置组播地址、端口和接口地址
2. 点击 "开始监听" 按钮启动组播监听
3. 监听状态会实时显示在状态区域

### 4. 查看接收到的数据

- 接收到的数据包会实时显示在数据包列表中
- 每个数据包包含：
  - 接收时间
  - 数据来源（IP:端口）
  - 数据大小
  - 数据内容（UTF-8格式）
  - **Protobuf解析结果**（如果数据格式匹配）

### 5. Protobuf数据解析

应用支持解析以下类型的protobuf数据包：
- **飞行状态信息** (0x01) - 无人机飞行状态、姿态、发动机信息等
- **心跳数据** (0x02) - 内部心跳信息
- **场景初始化** (0x03) - 场景初始化数据
- **飞行控制** (0x10) - 飞行控制命令
- **姿态控制** (0x11) - 姿态控制命令
- **发动机控制** (0x12) - 发动机控制命令
- **航线上传** (0x20) - 航线上传数据
- **安全边界控制** (0x21) - 安全边界控制
- **定点导航** (0x22) - 定点导航数据
- **靶场点选择** (0x23) - 靶场点选择
- **导航回复** (0x24) - 导航信息回复
- **航线上传回复** (0x25) - 航线上传回复
- **导航模式请求** (0x26) - 导航模式请求
- **定位模式请求** (0x27) - 定位模式请求
- **回收航线命令** (0x28) - 回收航线命令

### 5. 功能操作

- **自动滚动**: 开启后新数据包会自动滚动到列表底部
- **清空数据**: 清除所有已接收的数据包
- **导出数据**: 将接收到的数据包导出为JSON文件

## 测试组播功能

### 使用提供的测试脚本

项目根目录提供了两个测试脚本：

1. **基础测试脚本** `test-multicast.js`：
```bash
node test-multicast.js
```
这个脚本会每5秒向配置的组播地址发送一次简单的文本测试数据。

2. **Protobuf测试脚本** `test-protobuf-multicast.js`：
```bash
node test-protobuf-multicast.js
```
这个脚本会发送各种类型的protobuf格式数据，包括：
- 心跳数据
- 飞行状态信息
- 飞行控制命令
- 姿态控制命令
- 发动机控制命令

建议使用protobuf测试脚本来验证完整的解析功能。

### 手动测试

你也可以使用其他工具发送组播数据：

```bash
# 使用 netcat 发送测试数据
echo "测试数据" | nc -u 224.0.0.1 8888
```

## 技术实现

### 架构说明

1. **主进程**: 使用 Node.js 的 `dgram` 模块创建UDP socket监听组播
2. **渲染进程**: Vue 3 组件提供用户界面
3. **IPC通信**: 通过 Electron 的 IPC 机制在主进程和渲染进程间传递数据

### 核心文件

- `src/main/services/multicast.service.ts`: 组播服务实现
- `src/main/services/protobuf-parser.service.ts`: Protobuf解析服务
- `src/main/main.ts`: 主进程集成组播服务
- `src/renderer/views/pages/MulticastPage.vue`: 组播监听界面
- `src/protobuf/`: Protobuf定义文件目录
  - `PublicStruct.proto`: 公共结构定义
  - `UavNavMonitorStruct.proto`: 导航监控结构定义
  - `UavFlyMonitorStruct.proto`: 飞行监控结构定义
  - `UaviationSimulationStruct.proto`: 航空仿真结构定义
- `config.env`: 环境配置文件

### 数据流程

1. 组播数据包到达 → 主进程接收
2. 主进程尝试protobuf解析 → 解析成功则显示结构化数据，失败则显示原始数据
3. 主进程通过IPC发送数据给渲染进程
4. 渲染进程接收数据 → 更新界面显示

## 注意事项

1. **权限要求**: 在某些系统上，监听组播可能需要管理员权限
2. **防火墙设置**: 确保防火墙允许UDP流量通过指定端口
3. **网络环境**: 组播功能需要网络支持组播协议
4. **数据格式**: 当前实现将接收到的数据按UTF-8格式解析显示

## 故障排除

### 常见问题

1. **无法启动监听**
   - 检查端口是否被占用
   - 确认有足够的权限
   - 验证网络接口配置

2. **接收不到数据**
   - 确认发送方使用正确的组播地址和端口
   - 检查网络防火墙设置
   - 验证网络支持组播

3. **数据乱码**
   - 检查数据编码格式
   - 确认发送方使用UTF-8编码

### 调试方法

1. 查看主进程控制台输出
2. 检查网络连接状态
3. 使用网络抓包工具验证数据包

## 扩展功能

未来可以考虑添加的功能：

1. 支持多种数据格式解析（JSON、XML、二进制等）
2. 数据包过滤功能
3. 数据包统计和分析
4. 多组播地址同时监听
5. 数据包重放功能 